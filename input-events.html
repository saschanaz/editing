<!DOCTYPE html>
<html lang='en'>
  <head>
    <meta charset='utf-8'>
    <title>Input Events</title>
    <script src='http://www.w3.org/Tools/respec/respec-w3c-common' async class='remove'></script>
    <script class='remove'>
      var respecConfig = {
              specStatus:   "unofficial"
          ,   shortName:    "input-events"
          ,   editors:      [{ name: "Ben Peters", 
                               mailto: "BenjamP@microsoft.com",
                               company: "Microsoft", 
                               companyURL: "http://www.microsoft.com" }]
          ,   wg:           "Web Applications Working Group"
          ,   wgURI:        "http://www.w3.org/2008/webapps/"
          ,   wgPublicList: "public-webapps"
          ,   wgPatentURI:  "http://www.w3.org/2004/01/pp-impl/40318/status"
          ,   edDraftURI:   "http://w3c.github.io/editing-explainer/input-events.html"
          ,   license:      "cc-by"
        };
    </script>
  </head>
  <body>
    <section id='abstract'>
      <p>
       This specification defines events for text and related input and provides relavant contextual information for each event. 
       This specification builds on the Document Object Model Events Level 3.
      </p>
    </section>
    <section id='sotd'>
      <p>
      </p>
    </section>
    <section>
      <h2>Introduction</h2>
      <p>
        This documen describes 2 events- Input (which already exists and is being extended) and beforeInput (which is newly defined here). 
        The goal of these events is to allow authors to understand and/or override default input behavior both before and after input occurs.
      </p>
    </section>
    <section>
      <h2>Problem and Use Cases</h2>
        The problems solved by and use cases for this document by this document are tracked in the <a href="http://w3c.github.io/editing-explainer/">Editing Explainer</a> document.
    </section>
    <section id="events-inputevents">
			<h3>Input Event Types</h3>
			<p>Input events are sent as notifications whenever the DOM is being updated.</p>
			
			<section id="interface-InputEvent">
				<h4>Interface InputEvent</h4>

				<dl class="idl" title="[Constructor(DOMString typeArg, optional InputEventInit inputEventInitDict)] interface InputEvent : UIEvent">
					<dt>readonly attribute DOMString data</dt>
					<dd>
						<p><code>data</code> holds the value of the characters generated by an input method.
							This MAY be a single Unicode character or a non-empty sequence of Unicode characters
							[<cite><a class="normative" href="#references-Unicode">Unicode</a></cite>].
							Characters SHOULD be normalized as defined by the Unicode normalization form <em>NFC</em>,
							defined in [<cite><a class="normative" href="#references-UnicodeNormalization">UAX #15</a></cite>].
							This attribute MAY contain the <a class="def" href="#glossary-empty-string">empty string</a>.
							</p>

						<p>The <a class="def" href="#glossary-un-initialized-value">un-initialized value</a> of this attribute
							MUST be <code>""</code> (the empty string).
							</p>
					</dd>
                    <dt>readonly attribute DOMString intention</dt>
					<dd>
						<p><code>intention</code> holds the type of input.
							Allowed values include insertText, insertNewline, insertHTML, delete, undo, redo.
							</p>

						<p>The <a class="def" href="#glossary-un-initialized-value">un-initialized value</a> of this attribute
							MUST be <code>""</code> (the empty string).
							</p>
					</dd>
					<dt>readonly attribute boolean isComposing</dt>
					<dd>
						<p><code>true</code> if the input event occurs as part of a composition session, i.e., after a
							<a class="eventtype" href="#event-type-compositionstart"><code>compositionstart</code></a>
							event and before the corresponding
							<a class="eventtype" href="#event-type-compositionend"><code>compositionend</code></a>
							event.
							</p>

						<p>The <a class="def" href="#glossary-un-initialized-value">un-initialized value</a> of this
							attribute MUST be <code>false</code>.
							</p>
					</dd>
                    <dt>readonly attribute Range targetRange</dt>
					<dd>
						<p>the Range in the document that is affected by this event.
							</p>
					</dd>
				</dl>
				
				<dl class="idl" title="dictionary InputEventInit : UIEventInit">
					<dt>DOMString data = ""</dt>
					<dd>
						<p>Initializes the <code>data</code> attribute of the InputEvent object.
							</p>
					</dd>

					<dt>boolean isComposing = false</dt>
					<dd>
						<p>Initializes the <code>isComposing</code> attribute of the InputEvent object.
							</p>
					</dd>
				</dl>

			</section>  <!-- interface-InputEvent -->

			<section id="events-inputevent-event-order">
				<h4>Input Event Order</h4>

				<p>The input events defined in this specification MUST occur in a set order relative to one another.
					</p>

				<table class="event-sequence-table">
					<tr>
						<td class="cell-number">1.</td>
						<td><a class="eventtype" href="#event-type-beforeinput"><code>beforeinput</code></a></td>
						<td></td>
					</tr>
					<tr>
						<td class="cell-number"></td>
						<td colspan="2"><em>DOM element is updated</em></td>
					</tr>
					<tr>
						<td class="cell-number">2.</td>
						<td><a class="eventtype" href="#event-type-input"><code>input</code></a></td>
						<td></td>
					</tr>
				</table>

			</section>  <!-- events-inputevent-event-order -->
			
			<p>The Input event types are listed below.</p>

			<!-- beforeinput -->
			<div class="event-definition">
				<dl>
					<dt id="event-type-beforeinput"><dfn><a class="eventtype" href="#event-type-beforeinput"><code>beforeinput</code></a></dfn></dt>
					<dd>
						<table border="0" summary="This table contains information about the semantics of the given event type" cellpadding="2" cellspacing="0">
							<tr>
								<th>Type</th>
								<td><strong><code>beforeinput</code></strong></td>
							</tr>
							<tr>
								<th>Interface</th>
								<td><a href="#interface-InputEvent"><code>InputEvent</code></a></td>
							</tr>
							<tr>
								<th>Sync / Async</th>
								<td>Sync</td>
							</tr>
							<tr>
								<th>Bubbles</th>
								<td>Yes</td>
							</tr>
							<tr>
								<th>Trusted Targets</th>
								<td><code>Element</code> (specifically: control types such as <code>HTMLInputElement</code>, etc.) or any <code>Element</code> with 
									<code>contenteditable</code> attribute enabled.</td>
							</tr>
							<tr>
								<th>Cancelable</th>
								<td>Yes</td>
							</tr>
							<tr>
								<th>Default action</th>
								<td>Update the DOM according to the <a href="#default-action-for-beforeinput">algorithms below</a>.</td>
							</tr>
							<tr>
								<th>Context<br/>(trusted events)</th>
								<td>
									<ul>
										<li><a href="#widl-Event-target"><code class="attribute-name">Event.target</code></a>:
											<a class="def" href="#glossary-event-target">event target</a> that is about to be updated</li>
										<li><a href="#widl-UIEvent-view"><code class="attribute-name">UIEvent.view</code></a>:
											<a class="def" href="#glossary-window"><code>Window</code></a></li>
										<li><a href="#widl-UIEvent-detail"><code class="attribute-name">UIEvent.detail</code></a>:
											<code>0</code></li>
										<li><a href="#widl-InputEvent-data"><code class="attribute-name">InputEvent.data</code></a>:
											the string containing the data that will be added to the element,
											which MAY be the <a class="def" href="#glossary-empty-string">empty string</a> if the content has been deleted</li>
										<li><a href="#widl-InputEvent-isComposing"><code class="attribute-name">InputEvent.isComposing</code></a>:
											<code>true</code> if this event is dispatched during a <a href="#keys-dead">dead key</a> sequence or while an 
											<a href="#glossary-ime">input method editor</a> is active (such that 
											<a href="#events-compositionevents">composition events</a> are being dispatched); <code>false</code> otherwise.</li>
									</ul>
								</td>
							</tr>
						</table>

						<p>A <a class="def" href="#glossary-user-agent">user agent</a> MUST dispatch this event when the DOM is about to be updated.</p>
					</dd>
				</dl>
			</div><!-- beforeinput -->

			<!-- input -->
			<div class="event-definition">
				<dl>
					<dt id="event-type-input"><dfn><a class="eventtype" href="#event-type-input"><code>input</code></a></dfn></dt>
					<dd>
						<table border="0" summary="This table contains information about the semantics of the given event type" cellpadding="2" cellspacing="0">
							<tr>
								<th>Type</th>
								<td><strong><code>input</code></strong></td>
							</tr>
							<tr>
								<th>Interface</th>
								<td><a href="#interface-InputEvent"><code>InputEvent</code></a></td>
							</tr>
							<tr>
								<th>Sync / Async</th>
								<td>Sync</td>
							</tr>
							<tr>
								<th>Bubbles</th>
								<td>Yes</td>
							</tr>
							<tr>
								<th>Trusted Targets</th>
								<td><code>Element</code> (specifically: control types such as <code>HTMLInputElement</code>, etc.) or any <code>Element</code> with 
									<code>contenteditable</code> attribute enabled.</td>
							</tr>
							<tr>
								<th>Cancelable</th>
								<td>No</td>
							</tr>
							<tr>
								<th>Default action</th>
								<td>None</td>
							</tr>
							<tr>
								<th>Context<br/>(trusted events)</th>
								<td>
									<ul>
										<li><a href="#widl-Event-target"><code class="attribute-name">Event.target</code></a>:
											<a class="def" href="#glossary-event-target">event target</a> that was just updated</li>
										<li><a href="#widl-UIEvent-view"><code class="attribute-name">UIEvent.view</code></a>:
											<a class="def" href="#glossary-window"><code>Window</code></a></li>
										<li><a href="#widl-UIEvent-detail"><code class="attribute-name">UIEvent.detail</code></a>:
											<code>0</code></li>
										<li><a href="#widl-InputEvent-data"><code class="attribute-name">InputEvent.data</code></a>:
											the string containing the data that was added to the element,
											which MAY be the <a class="def" href="#glossary-empty-string">empty string</a> if the content has been deleted</li>
										<li><a href="#widl-InputEvent-isComposing"><code class="attribute-name">InputEvent.isComposing</code></a>:
											<code>true</code> if this event is dispatched during a <a href="#keys-dead">dead key</a> sequence or while an 
											<a href="#glossary-ime">input method editor</a> is active (such that 
											<a href="#events-compositionevents">composition events</a> are being dispatched); <code>false</code> otherwise.</li>
									</ul>
								</td>
							</tr>
						</table>

						<p>A <a class="def" href="#glossary-user-agent">user agent</a> MUST dispatch this event immediately after the DOM has been updated.</p>
					</dd>
				</dl>
			</div><!-- input -->

		</section>  <!-- events-inputevents -->

        <section id="events-composition-event-input-events">
				<h4>Input Events During Composition</h4>
				
				<p>During the composition session, the 
					<a class="eventtype" href="#event-type-compositionupdate"><code>compositionupdate</code></a> MUST be dispatched
					before the <a class="eventtype" href="#event-type-beforeinput"><code>beforeinput</code></a> and <code>input</code> events are sent.
					</p>

				<table class="event-sequence-table">
					<tr>
						<td class="cell-number"></td>
						<th>Event Name</th>
						<th>Notes</th>
					</tr>
					<tr>
						<td class="cell-number">1.</td>
						<td><a class="eventtype" href="#event-type-compositionupdate"><code>compositionupdate</code></a></td>
						<td></td>
					</tr>
					<tr>
						<td class="cell-number">2.</td>
						<td><a class="eventtype" href="#event-type-beforeinput"><code>beforeinput</code></a></td>
						<td></td>
					</tr>
					<tr>
						<td class="cell-number"></td>
						<td></td>
						<td><em>Any DOM updates occur at this point.</em></td>
					</tr>
					<tr>
						<td class="cell-number">3.</td>
						<td><a class="eventtype" href="#event-type-input"><code>input</code></a></td>
						<td></td>
					</tr>
				</table>

				<p class="note"><strong>Note:</strong> Most IMEs do not support canceling updates
					during a composition session.
					</p>

				<p>When a composition session is finished, any 
					<a class="eventtype" href="#event-type-beforeinput"><code>beforeinput</code></a> and 
					<a class="eventtype" href="#event-type-input"><code>input</code></a> events MUST be dispatched after the 
					<a class="eventtype" href="#event-type-compositionend"><code>compositionend</code></a> event.
					</p>

				<table class="event-sequence-table">
					<tr>
						<td class="cell-number"></td>
						<th>Event Name</th>
						<th>Notes</th>
					</tr>
					<tr>
						<td class="cell-number">1.</td>
						<td><a class="eventtype" href="#event-type-compositionend"><code>compositionend</code></a></td>
						<td></td>
					</tr>
					<tr>
						<td class="cell-number">2.</td>
						<td><a class="eventtype" href="#event-type-beforeinput"><code>beforeinput</code></a></td>
						<td><em>Sent only if weâ€™re about to update the DOM (i.e., the composition was not canceled).
							Canceling this will prevent the DOM update and the 
							<a class="eventtype" href="#event-type-input"><code>input</code></a> event.</em></td>
					</tr>
					<tr>
						<td class="cell-number"></td>
						<td></td>
						<td><em>Any DOM updates occur at this point.</em></td>
					</tr>
					<tr>
						<td class="cell-number">3.</td>
						<td><a class="eventtype" href="#event-type-input"><code>input</code></a></td>
						<td><em>Sent only if the DOM was updated.</em></td>
					</tr>
				</table>
				
				<p class="note"><strong>Note:</strong> Some IMEs update the DOM before the
					<a class="eventtype" href="#event-type-compositionend"><code>compositionend</code></a> event is dispatched.
					In this case, canceling the <a class="eventtype" href="#event-type-beforeinput"><code>beforeinput</code></a>
					event will have no effect (i.e., the <a class="eventtype" href="#event-type-input"><code>input</code></a>
					event will still fire).</p>

			</section>  <!-- events-composition-event-input-events -->

    <section>
    <h2>Default action for beforeInput</h2>
    <p>The default action of a given beforeinput event depends on the value of the intention property on the event. All of this can be prevented with preventDefault(). 
    For all beforeInput events, if any part of targetRange is not Editable, abort these steps.
    <p>
    <p>The default action of a beforeInput event with intention="insertText" shall be as follows:
    <ol><li>If targetRange is not collapsed, abort these steps
    </li><li>If data is not a string, abort these steps
    </li><li>Insert data at the location of targetRange in the document
    </li></ol>
    </p><p>The default action of a beforeInput event with intention="insertNewline" shall be as follows:
    <ol><li>If targetRange is not collapsed, abort these steps
    </li><li>If data is not a known paragraph separator ("div", "p", or "br"), abort these steps.
    </li><li>NEED ALGORITHM to split nodes
    </li><li>Wrap the beforeNode and afterNode in the tag given by data
    </li><li>NEED ALGORITHM to simplify nodes for both beforeNode and afterNode
    </li></ol>
    </p>
    <section>
    <h2>intention="delete"</h2>
    <p>The default action of a beforeInput event with intention="delete" shall be as follows. The image below shows one possible scenario for this intention.<div><img src="images\inputEvents\Intial_State.png" style="width:600px"></div>
    <ol><li>If the Node referenced by targetRange.startContainer is a TextNode and targetRange.startOffset is greater than 0, call targetRange.startContainer.splitText(targetRange.startOffset).
    </li><li>If the Node referenced by targetRange.endContainer is a TextNode and targetRange.endOffset is less than targetRange.endContainer.length-1, call targetRange.endContainer.splitText(targetRange.endOffset).
    </li><li>Remove all TextNodes that are contained by targetRange from the document<div><img src="images\inputEvents\TextNodes_Gone.png" style="width:600px"></div>
    </li><li>Remove all Nodes from the document that are wholly contained by targetRange<div><img src="images\inputEvents\Middle_Blocks_Gone.png" style="width:600px"></div>
    </li><li>The content of targetRange should now be in ET*BT* format.
    </li><li>Run the Merge Blocks algorithm<div><img src="images\inputEvents\Blocks_Merged.png" style="width:600px"></div>
    </li><li>run targetRange.collapse(true)<div><img src="images\inputEvents\Selection_Collapsed.png" style="width:600px"></div>
    </li></ol>
    </p>
    </section>
    <p>The default action of a beforeInput event with intention="format" is unspecified
    </p><p>The default action of a beforeInput event with intention="undo" or "redo" shall be as follows. 
    Note that this may not be completely interoperable in the size of the undo unit.
    However, browsers must reset to a state that previously existed in the document, and X undo operations
    followed by X redo operations must return to the original state, and vice versa. 
    <ol><li>Undo or redo as appropriate based on the browser's undo stack.
    </li></ol>
    </p>
    <section>
    <h2>Helper Algorithms and Definitions</h2>
    <section>
    <h2>ET*BT*</h2>
        This is a convenient way to describe a recurring markup shape. It is a regular expression, with zero or more End Tags followed by zero or more Begin Tags in HTML. For instance, &lt;/span&gt;&lt;/div&gt;&lt;p&gt;
    </section>
    <section>
    <h2>Mergeable</h2>
        Two elements are mergable if they meet the following requirements:
        <ol><li>Neither of them has any of the following tags: "a", "hr", WHAT ELSE??
        </li><li>They have the same value for computedStyle.display
        </li><li>The following special cases are satisfied:
        <ol><li>If either of them is a list, they must both be lists. They do not need to be the same type of list.
        </li></ol>
        </li><li>TODO: WHAT ELSE??
        </li></ol>
    </section>
    <section>
        <h2>Merge Blocks</h2>
        Given a series of tags in ET*BT*, execute the following steps:
        <div><img src="images\inputEvents\ETBT.png" style="width:600px"></div>
        <ol><li>Let ET0 be the right-most End Tag, and ETi be the End Tag i places left of ET0
        </li><li>Let BT0 be the left-most Begin Tag, and BTi be the Begin Tag i places right of ET0
        </li><li>Let i = 0
        </li><li>If ETi does not exist or BTi does not exist, abort these steps
        </li><li>If ETi is Mergeable with BTi, place all of the contents of BTi into ETi, after it's current contents
        </li><li>Remove BTi from the document
        </li><li>Recur at step 4 with i++
        </li></ol>
        Now the picture will look like this:
        <div><img src="images\inputEvents\ETBT_After.png" style="width:600px"></div>
    </section>
    </section>
    </section>
    
    <section>
      <h2>Acknowledgements</h2>
      Thanks to Travis Leithead, Gary Kacmarcik, and the other folks that worked on this in DOM L3 Events.<br>
      Thanks to Eugene Veselov for help with the algorithms.
    </section>
  </body>
</html>
